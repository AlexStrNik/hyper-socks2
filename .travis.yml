language: rust
cache:
    - cargo
    - ccache
rust:
    - stable
    - beta
    - nightly

matrix:
    allow_failures:
        - rust: nightly

addons:
    apt:
        sources:
            - ubuntu-toolchain-r-test
        packages:
            - gcc
            - libssl-dev

before_cache:
    - |
        if [[ "$TRAVIS_RUST_VERSION" == nightly ]]; then
            RUSTFLAGS="--cfg procmacro2_semver_exempt" cargo install cargo-tarpaulin -f
        fi

script:
    - git clone https://github.com/z3APA3A/3proxy
    - cd 3proxy
    - make CC='ccache gcc' -f Makefile.Linux -j2
    - cd bin
    - |
        echo "
        internal 127.0.0.1
        users hyper:CL:proxy
        auth none strong
        socks
        " > 3proxy.cfg
    - ./3proxy 3proxy.cfg &
    - cd ../..
    - cargo build -v --all
    - cargo test -v --all

after_success: |
    if [[ "$TRAVIS_RUST_VERSION" == nightly ]]; then
        cargo tarpaulin --ciserver travis-ci --coveralls $TRAVIS_JOB_ID
        cargo tarpaulin --out Xml
        bash <(curl -s https://codecov.io/bash)
    fi
